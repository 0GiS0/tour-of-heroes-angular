name: üè∑Ô∏è Copilot Discussion Labeler

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Only analyze, don't add labels"
        required: false
        default: false
        type: boolean
  workflow_run:
    workflows: ["üí° Copilot Suggester (Discussion Mode)"]
    types:
      - completed

permissions:
  contents: read
  discussions: write

jobs:
  label-discussions:
    name: üè∑Ô∏è Add Labels to Unlabeled Discussions
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: üè∑Ô∏è Find and label discussions without labels
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          # Copilot CLI finds unlabeled discussions and adds appropriate labels
          copilot -p "
          You are a discussion labeler bot. Your task is to find discussions without labels and add appropriate labels to them.

          DRY RUN MODE: $DRY_RUN (if true, only report what you would do, don't actually add labels)

          Follow these steps:

          1. FIRST: Use the GitHub MCP Server to list ALL available labels in this repository.
             SAVE this list - you will use these labels to tag discussions.
             Common labels to look for: enhancement, bug, documentation, security, performance, question, help wanted, good first issue, etc.

          2. SECOND: Use the GitHub MCP Server to list ALL discussions in this repository.
             Focus especially on discussions in the 'Ideas' category.
             For each discussion, check if it has labels assigned.

          3. THIRD: For each discussion that has NO labels (or was auto-generated by Copilot CLI):
             - Read the discussion title and body carefully
             - Determine the appropriate labels based on the content:
               * If it's about security ‚Üí add 'security' label (if exists) or 'enhancement'
               * If it's about performance ‚Üí add 'performance' label (if exists) or 'enhancement'  
               * If it's about documentation ‚Üí add 'documentation' label
               * If it's about testing ‚Üí add 'testing' label (if exists) or 'enhancement'
               * If it's about bugs/fixes ‚Üí add 'bug' label
               * If it's about new features ‚Üí add 'enhancement' label
               * If it's about refactoring/code quality ‚Üí add 'enhancement' or 'refactoring' label
               * If it's about configuration ‚Üí add 'configuration' label (if exists) or 'enhancement'
               * If it's about architecture ‚Üí add 'enhancement' label
               * Always try to add a 'üí° suggestion' label if it exists and the discussion was auto-generated

          4. FOURTH: If DRY_RUN is false, use the GitHub MCP Server to add the determined labels to each unlabeled discussion.
             If DRY_RUN is true, just report what labels you would add to which discussions.

          IMPORTANT: 
          - Only use labels that actually exist in the repository (from step 1)
          - Each discussion should have at least 1-3 relevant labels
          - Don't add too many labels - be specific and relevant
          - If a discussion already has labels, skip it unless it's missing obvious ones
          
          Report a summary at the end showing:
          - Total discussions checked
          - Discussions that needed labels
          - Labels added (or would be added in dry run mode)
          " --allow-all-tools

          echo "‚úÖ Discussion labeling completed"
