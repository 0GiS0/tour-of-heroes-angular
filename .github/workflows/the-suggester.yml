name: ðŸ’¡ Copilot Suggester (Discussion Mode)

on:
  # schedule:
  #   - cron: "0 9 * * 1" # Monday 9:00 UTC
  workflow_dispatch:
    inputs:
      suggestion_type:
        description: "Type of suggestions to look for"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - security
          - performance
          - refactoring
          - testing
          - documentation
          - architecture
          - configuration
          - bugs
          - maintainability

permissions:
  contents: read
  discussions: write

jobs:
  review:
    name: ðŸ” Analyze & Create Discussion Ideas
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ðŸ¤– Analyze code and create discussions with Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          SUGGESTION_TYPE: ${{ inputs.suggestion_type || 'all' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          # Build the prompt based on suggestion type
          if [ "$SUGGESTION_TYPE" = "all" ]; then
            CATEGORIES="Security, Performance, Refactoring, Testing, Documentation, Architecture, Configuration, Bugs, and Maintainability"
          else
            CATEGORIES="$SUGGESTION_TYPE"
          fi

          # Copilot CLI analyzes the repo and creates discussions using its GitHub MCP Server
          copilot -p "
          You are analyzing this repository to find improvement suggestions. Follow these steps:

          1. FIRST: Use the GitHub MCP Server to list ALL available discussion categories in this repository.
             Look specifically for a category named 'Ideas' or similar (like 'ðŸ’¡ Ideas', 'Feature requests', etc.).
             SAVE the category ID - you MUST use it when creating discussions.

          2. SECOND: Use the GitHub MCP Server to review the last 5 discussions in this repository to understand:
             - The language used (Spanish, English, etc.)
             - The title structure (emojis, prefixes, etc.)
             - The body structure (sections, formatting)

          3. THIRD: Analyze all the code in this repository looking for improvements in: $CATEGORIES

          4. FOURTH: For each important suggestion found, create a DISCUSSION (not an issue) in this repository.
             CRITICAL REQUIREMENTS for each discussion:
             - Category: Use the 'Ideas' category (or equivalent found in step 1)
             - Title: Follow EXACTLY the same style as existing discussions
             - Language: Use the SAME language as existing discussions
             - Body: Use the SAME structure as existing discussions
             - Include a section explaining what the suggestion is and why it would improve the codebase
             - Footer: Include 'This discussion was automatically generated by Copilot CLI'

          Create individual discussions for each important suggestion, not a single discussion with everything.
          Use the GitHub MCP Server's create_discussion tool to create each discussion in the 'Ideas' category.
          " --allow-all-tools

          echo "âœ… Copilot CLI analysis completed"
