name: üí° Copilot Suggester (Discussion Mode)

on:
  # schedule:
  #   - cron: "0 9 * * 1" # Monday 9:00 UTC
  workflow_dispatch:
    inputs:
      suggestion_type:
        description: "Type of suggestions to look for"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - security
          - performance
          - refactoring
          - testing
          - documentation
          - architecture
          - configuration
          - bugs
          - maintainability

permissions:
  contents: read
  discussions: write

jobs:
  review:
    name: üîç Analyze & Create Discussion Ideas
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ü§ñ Analyze code and create discussions with Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          SUGGESTION_TYPE: ${{ inputs.suggestion_type || 'all' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          # Build the prompt based on suggestion type
          if [ "$SUGGESTION_TYPE" = "all" ]; then
            CATEGORIES="Security, Performance, Refactoring, Testing, Documentation, Architecture, Configuration, Bugs, and Maintainability"
          else
            CATEGORIES="$SUGGESTION_TYPE"
          fi

          # Copilot CLI analyzes the repo and creates discussions using its GitHub MCP Server
          copilot -p "
          You are analyzing this repository to find improvement suggestions. Follow these steps:

          1. FIRST: Use the GitHub MCP Server to list ALL available discussion categories in this repository.
             Look specifically for a category named 'Ideas' or similar (like 'üí° Ideas', 'Feature requests', etc.).
             SAVE the category ID - you MUST use it when creating discussions.

          2. SECOND: Use the GitHub MCP Server to review the last 5 discussions in this repository to understand:
             - The language used (Spanish, English, etc.)
             - The title structure (emojis, prefixes, etc.)
             - The body structure (sections, formatting)

          3. THIRD: Analyze all the code in this repository looking for improvements in: $CATEGORIES

          4. FOURTH: Before creating any discussion, use the GitHub MCP Server to search for existing ISSUES 
             in this repository that might be related to each suggestion.
             - Search issues using relevant keywords from your suggestion
             - Check both open AND closed issues
             - If an issue already exists that covers the same topic/improvement, DO NOT create a discussion for it
             - Only proceed to create a discussion if NO related issue exists

          5. FIFTH: For each important suggestion that has NO related existing issue, create a DISCUSSION in this repository.
             CRITICAL REQUIREMENTS for each discussion:
             - Category: Use the 'Ideas' category (or equivalent found in step 1)
             - Title: Follow EXACTLY the same style as existing discussions
             - Language: Use the SAME language as existing discussions
             - Body: Use the SAME structure as existing discussions
             - Include a section explaining what the suggestion is and why it would improve the codebase
             - Footer: Include 'This discussion was automatically generated by Copilot CLI'
             
             ‚ö†Ô∏è LABELS ARE MANDATORY ‚ö†Ô∏è
             After creating each discussion, you MUST add labels to it using the GitHub MCP Server.
             - First, list available labels in the repository
             - Then, add appropriate labels based on the suggestion type (e.g., 'enhancement', 'security', 'performance', 'documentation', etc.)
             - Every discussion MUST have at least one label. DO NOT skip this step!

          Create individual discussions for each important suggestion, not a single discussion with everything.
          Use the GitHub MCP Server's create_discussion tool to create each discussion in the 'Ideas' category.
          REMEMBER: Skip any suggestion that already has a related issue in the repository!
          CRITICAL: After creating each discussion, you MUST add labels to it. Discussions without labels are NOT acceptable!
          " --allow-all-tools

          echo "‚úÖ Copilot CLI analysis completed"
